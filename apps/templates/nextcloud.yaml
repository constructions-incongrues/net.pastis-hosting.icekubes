apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nextcloud
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    server: https://kubernetes.default.svc
    namespace: jeancloude-club-nextcloud
  project: jeancloude.club
  source:
    chart: nextcloud
    helm:
      values: |
        image:
          tag: 23.0.0-apache
        replicaCount: 2
        cronjob:
          enabled: true
        internalDatabase:
          enabled: false
        mariadb:
          enabled: true
          architecture: standalone
          primary:
            persistence:
              enabled: true
        nginx:
          enabled: false
        persistence:
          enabled: true
        redis:
          enabled: true
        nextcloud:
          host: app.jeancloude.club
          configs:
            caching.config.php: |-
              <?php
              $CONFIG = [
                'memcache.local' => '\OC\Memcache\APCu',
                'memcache.distributed' => '\OC\Memcache\Redis',
                'memcache.locking' => '\OC\Memcache\Redis',
                'redis' => [
                  'host' => getenv('REDIS_HOST'),
                  'port' => getenv('REDIS_HOST_PORT') ?: 6379,
                  'password' => getenv('REDIS_HOST_PASSWORD')
                ]
              ];
            logging.config.php: |-
              <?php
              $CONFIG = [
                'log_level' => 2,
                "log_type" => "errorlog",
              ];

            objectstore.config.php: |-
              <?php
              $CONFIG = [
                'objectstore' => [
                  'class' => 'OC\\Files\\ObjectStore\\Swift',
                  'arguments' => [
                    'autocreate' => 'true',
                    'user' => [
                      'name' => 'user-KPNf2CXgFmYY',
                      'password' => 'ChaDQNt8R6CpWeaHfDNeWmzd6edhDmwW',
                      'domain' => [
                        'name' => 'Default',
                      ]
                    ],
                    'url' => 'https://auth.cloud.ovh.net/v3/',
                    'bucket' => 'club-jeancloude-nextcloud_01',
                    'region' => 'GRA',
                    'scope' => [
                      'project' => [
                        'name' => '8966606530353673',
                        'domain' => [
                          'name' => 'Default',
                        ],
                      ],
                    ],
                  ],
                ],
              ];

            preview.config.php: |-
              <?php
              $CONFIG = [
                'filelocking.enabled' => true,
                'enable_previews' => true,
              ];

            oidc_login.config.php: |-
              <?php
              $CONFIG = [
                'lost_password_link' => 'disabled',
                'oidc_login_provider_url' => 'https://cartemembre.jeancloude.club/auth/realms/jeancloude.club',
                'oidc_login_logout_url' => 'https://cartemembre.jeancloude.club/auth/realms/jeancloude.club/protocol/openid-connect/logout?redirect_uri=https%3A%2F%2Fapp.jeancloude.club%2F',
                'oidc_login_client_id' => 'nextcloud',
                'oidc_login_client_secret' => 'LUQ548TPo2EKON34dCqfcH0TAdQFkTjr',
                'oidc_login_auto_redirect' => false,
                'oidc_login_hide_password_form' => true,
                'oidc_login_redir_fallback' => true,
                'oidc_login_scope' => 'openid profile',
                'oidc_login_attributes' => [
                  'id' => 'preferred_username',
                  'name' => 'name',
                  'mail' => 'email',
                ],
              ];

            proxy.config.php: |-
              <?php
              $CONFIG = [
                'overwriteprotocol' => 'https',
                'overwrite.cli.url' => 'https://app.jeancloude.club',
                'trusted_domains' => [
                  'nextcloud',
                  'app.jeancloude.club'
                ]
              ];

        ingress:
          enabled: true
    repoURL: https://nextcloud.github.io/helm
    targetRevision: 2.11.2
  syncPolicy:
    # automated:
    #   prune: true
    #   selfHeal: true
    syncOptions:
      - CreateNamespace=true